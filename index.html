<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>静哥哥圣经</title>
        <script src="./waterfall.js"></script>
        <link rel="stylesheet" href="./style.css">
    </head>
    <body>
        <h1>静哥哥圣经</h1>
        <div class="actions">
            <input type="checkbox" id="toggleDisplay"></input>
            <label for="toggleDisplay">显示消息窗口</label>
            <input type="checkbox" id="toggleTitle"></input>
            <label for="toggleTitle">显示卡片标题</label>
            <input type="checkbox" id="toggleDetail"></input>
            <label for="toggleDetail">显示对话内容</label>
        </div>
        <div class="waterfall" id="waterfall"></div>
        <template id="message-template">
            <div class="message">
                <img class="message-avatar" alt="avatar" src="./assets/jing-avatar.jpg">
                <div class="message-body">
                    <div class="message-name">静哥哥</div>
                    <div class="message-content"></div>
                </div>
            </div>
        </template>
        <footer>
            <script type="module">
                window.state = {
                    showDialog: false,
                    showDetail: false,
                    showTitle: true
                };

                document.getElementById('toggleDisplay').addEventListener('click', () => {
                    state.showDialog = document.getElementById('toggleDisplay').checked;
                    renderContent();
                });

                document.getElementById('toggleTitle').addEventListener('click', () => {
                    state.showTitle = document.getElementById('toggleTitle').checked;
                    renderContent();
                });
                document.getElementById('toggleDetail').addEventListener('click', () => {
                    state.showDetail = document.getElementById('toggleDetail').checked;
                    renderContent();
                });

                const res = await fetch('./assets/quotations.json');
                /** @type {{ width: number, height: number, title: string, format: string, messages: string[] }[]} */
                const items = await res.json();

                const params = new URLSearchParams(window.location.search);

                /** @type {HTMLTemplateElement} */
                const messageTemplate = document.getElementById('message-template');

                function renderCard({ width, height, title, format = 'png', messages, footer }, showDialog) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.title = title;

                    if (showDialog) {
                        const container = document.createElement('div');
                        container.className = 'message-container';
                        for (let message of messages) {
                            const clone = messageTemplate.content.cloneNode(true);
                            if (message.startsWith('@')) {
                                clone.querySelector('.message-avatar').src = './assets/default-avatar.png';
                                clone.querySelector('.message-name').innerText = '群友';
                                message = message.substring(1);
                            }
                            clone.querySelector('.message-content').innerHTML = message;
                            container.appendChild(clone);
                        }
                        card.appendChild(container);
                    } else {
                        const img = document.createElement('img');
                        img.className = 'card-image';
                        img.alt = title;
                        img.src = `./assets/quotations/${title}.${format}`;
                        img.style.aspectRatio = `${width} / ${height}`;
                        card.appendChild(img);
                    }

                    if (!state.showTitle && !state.showDetail) {
                        return card;
                    }

                    const content = document.createElement('div');
                    content.className = 'card-content';
                    card.appendChild(content);

                    if (state.showTitle) {
                        content.innerHTML += `<h2 class="card-title"><a href="#${title}">${title}</a></h2>`;
                    }

                    if (state.showDetail) {
                        const html = messages.map(message => message.replace(/^@(.*)/, '<cite>$1</cite>')).join('<br>');
                        content.innerHTML += `<div class="card-text">${html}</div>`;
                    }

                    if (footer) {
                        card.innerHTML += `<div class="card-footer">${footer}</div>`;
                    }

                    return card;
                }

                const waterfall = new Waterfall('waterfall', [], 20);

                function resizeWaterfall() {
                    if (window.innerWidth >= 1440) {
                        waterfall.handleResize(4);
                    } else if (window.innerWidth >= 1024) {
                        waterfall.handleResize(3);
                    } else if (window.innerWidth) {
                        waterfall.handleResize(2);
                    }
                }
                window.addEventListener('resize', resizeWaterfall);

                function renderContent() {
                    // document.getElementById('toggleDisplay').textContent = state.showDialog ? '显示原始截图' : '显示消息窗口';
                    // document.getElementById('toggleDetail').textContent = state.showDetail ? '隐藏对话内容' : '显示对话内容';
                    // document.getElementById('toggleTitle').textContent = state.showTitle ? '显示卡片标题' : '隐藏卡片标题';

                    waterfall.elements = items.map(item => renderCard(item, state.showDialog));

                    for (let value of params.getAll('mock')) {
                        let [title, ...messages] = value.split(':');
                        waterfall.elements.push(renderCard({ title, messages }, true));
                    }

                    waterfall.renderColumns();
                    waterfall.distributeItems();
                }

                function scrollToHashIfValid() {
                    const hash = decodeURIComponent(window.location.hash.substring(1));
                    const element = document.querySelector(`[data-title="${hash}"]`);
                    if (element) {
                        element.classList.add('highlight');
                        setTimeout(() => element.classList.remove('highlight'), 1500);
                        element.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                window.addEventListener('hashchange', scrollToHashIfValid);

                resizeWaterfall();
                renderContent();
                scrollToHashIfValid();
            </script>
            Join us on GitHub: <a href="https://github.com/taichowjinggg">taichowjinggg</a>
        </footer>
    </body>
</html>